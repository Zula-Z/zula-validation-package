name: Zula CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]
  push: {}

permissions:
  contents: read
  pull-requests: write
  checks: write

  packages: read

jobs:
  build:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-zula-ci${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-zula-ci
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Configure Maven settings for GitHub Packages
        shell: bash
        run: |
          REPO_PATH=${GITHUB_REPOSITORY}
          cat > $GITHUB_WORKSPACE/settings.xml <<EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <activeProfiles><activeProfile>github</activeProfile></activeProfiles>
            <profiles>
              <profile>
                <id>github</id>
                <repositories>
                  <repository>
                    <id>github</id>
                    <name>GitHub Packages</name>
                    <url>https://maven.pkg.github.com/${REPO_PATH}</url>
                    <snapshots><enabled>true</enabled></snapshots>
                  </repository>
                </repositories>
              </profile>
            </profiles>
            <servers>
              <server>
                <id>github</id>
                <username>${GITHUB_ACTOR}</username>
                <password>${{ secrets.PACKAGES_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF
      - name: Build root (no deploy)
        env:
          GITHUB_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
        run: mvn -s $GITHUB_WORKSPACE/settings.xml -U clean install -DskipTests
      - name: Publish messages module (if present)
        if: ${{ hashFiles('zula-github-app-messages/pom.xml') != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
        run: |
          TARGET_REPO=${MESSAGES_REPO_PATH:-$GITHUB_REPOSITORY}
          mvn -s $GITHUB_WORKSPACE/settings.xml -pl zula-github-app-messages -am deploy -DskipTests \
            -DaltDeploymentRepository=github::default::https://maven.pkg.github.com/${TARGET_REPO}
      - name: Publish checks (placeholder)
        run: echo "Checks reported by GitHub automatically from job status."
      - name: Notify webhook
        env:
          WEBHOOK_URL: https://giktekdev.site/zula/backend/api/ci/notify
        run: |
          curl -X POST "$WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{"status":"completed","ref":"${{ github.ref }}"}'

  docker:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.CI_REGISTRY_USER }}
          password: ${{ secrets.CI_REGISTRY_PASSWORD }}
      - name: Build and push
        run: |
          docker build -t ghcr.io/your-org/your-app:latest .
          docker push ghcr.io/your-org/your-app:latest

# Required checks declared (informational): build, test, lint, security-scan

# Cache TTL (minutes): 1440
